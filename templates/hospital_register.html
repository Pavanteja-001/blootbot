<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hospital Registration - BloodBot</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body class="bg-gray-100">
  <div class="container mx-auto py-8">
    <h1 class="text-2xl font-bold text-center mb-6">Hospital Registration</h1>
    <form id="hospitalRegisterForm" class="max-w-lg mx-auto bg-white p-6 rounded shadow" enctype="multipart/form-data">
      <div id="formMessage" class="hidden mb-4 p-4 rounded"></div>

      <!-- Registration fields -->
      <div class="mb-4">
        <label class="block text-gray-700">Registration Number</label>
        <input type="text" name="registration_number" class="w-full border px-3 py-2 rounded" required>
      </div>
      <div class="mb-4">
        <label class="block text-gray-700">Hospital Name</label>
        <input type="text" name="name" id="hospitalName" class="w-full border px-3 py-2 rounded" required>
      </div>
      <div class="mb-4">
        <label class="block text-gray-700">Address</label>
        <input type="text" name="address" id="address" class="w-full border px-3 py-2 rounded" required>
      </div>
      <div class="mb-4">
        <label class="block text-gray-700">City</label>
        <input type="text" name="city" id="city" class="w-full border px-3 py-2 rounded" required>
      </div>
      <div class="mb-4">
        <label class="block text-gray-700">District</label>
        <input type="text" name="district" id="district" class="w-full border px-3 py-2 rounded" required>
      </div>
      <div class="mb-4">
        <label class="block text-gray-700">State</label>
        <input type="text" name="state" id="state" class="w-full border px-3 py-2 rounded" required>
      </div>
      <div class="mb-4">
        <label class="block text-gray-700">Password</label>
        <input type="password" name="password" id="password" class="w-full border px-3 py-2 rounded" required minlength="6">
        <p id="passwordError" class="text-red-500 text-sm mt-1 hidden">Password must be at least 6 characters.</p>
      </div>

      <!-- Blood inventory -->
      <div class="mb-4">
        <label class="block text-gray-700">Blood Inventory (Units)</label>
        <div class="grid grid-cols-2 gap-4">
          <div><label>A+</label><input type="number" name="A+" class="w-full border px-3 py-2 rounded" min="0" value="0"></div>
          <div><label>A-</label><input type="number" name="A-" class="w-full border px-3 py-2 rounded" min="0" value="0"></div>
          <div><label>B+</label><input type="number" name="B+" class="w-full border px-3 py-2 rounded" min="0" value="0"></div>
          <div><label>B-</label><input type="number" name="B-" class="w-full border px-3 py-2 rounded" min="0" value="0"></div>
          <div><label>AB+</label><input type="number" name="AB+" class="w-full border px-3 py-2 rounded" min="0" value="0"></div>
          <div><label>AB-</label><input type="number" name="AB-" class="w-full border px-3 py-2 rounded" min="0" value="0"></div>
          <div><label>O+</label><input type="number" name="O+" class="w-full border px-3 py-2 rounded" min="0" value="0"></div>
          <div><label>O-</label><input type="number" name="O-" class="w-full border px-3 py-2 rounded" min="0" value="0"></div>
        </div>
      </div>

      <!-- Hospital License Certificate -->
      <div class="mb-4">
        <label class="block text-gray-700">Hospital License Certificate</label>
        <input type="file" name="license_certificate" id="licenseCertificate" accept="image/*" class="w-full border px-3 py-2 rounded">
        <img id="licensePreview" class="mt-2 w-full h-48 object-contain hidden border rounded" alt="License Preview">
      </div>

      <!-- College Photo -->
      <div class="mb-4">
        <label class="block text-gray-700">Hospital Photo</label>
        <input type="file" name="hospital_photo" id="hospitalPhoto" accept="image/*" class="w-full border px-3 py-2 rounded">
        <img id="hospitalPreview" class="mt-2 w-full h-48 object-contain hidden border rounded" alt="hospital Photo Preview">
      </div>

      <!-- GPS Location -->
      <div class="mb-4">
        <label class="block text-gray-700">Hospital Location</label>
        <input type="text" id="locationDisplay" class="w-full border px-3 py-2 rounded bg-gray-100" readonly>
        <input type="hidden" name="latitude" id="latitude">
        <input type="hidden" name="longitude" id="longitude">
        <button type="button" id="updateLocationBtn" class="bg-green-500 text-white px-3 py-2 mt-2 rounded hover:bg-green-700">Update Location from Address</button>
        <div id="map" class="w-full h-64 mt-2 rounded border"></div>
      </div>

      <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-700">Register</button>
    </form>
    <p class="text-center mt-4"><a href="/hospital/login" class="text-blue-500">Already registered? Login here</a></p>
  </div>

  <script>
    let map, marker;

    function initMap(lat = 17.385044, lng = 78.486671) {
      map = L.map('map').setView([lat, lng], 14);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(map);

      marker = L.marker([lat, lng], { draggable: true }).addTo(map)
        .bindPopup('Drag to adjust hospital location')
        .openPopup();

      marker.on('dragend', function () {
        const pos = marker.getLatLng();
        document.getElementById("latitude").value = pos.lat;
        document.getElementById("longitude").value = pos.lng;
        document.getElementById("locationDisplay").value = Lat: ${pos.lat.toFixed(5)}, Lng: ${pos.lng.toFixed(5)};
      });
    }

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          initMap(pos.coords.latitude, pos.coords.longitude);
          document.getElementById("latitude").value = pos.coords.latitude;
          document.getElementById("longitude").value = pos.coords.longitude;
          document.getElementById("locationDisplay").value = Lat: ${pos.coords.latitude.toFixed(5)}, Lng: ${pos.coords.longitude.toFixed(5)};
        },
        () => { initMap(); }
      );
    } else {
      initMap();
    }

    async function geocodeAddress() {
      const address = `${document.getElementById("hospitalName").value}, 
                       ${document.getElementById("address").value}, 
                       ${document.getElementById("city").value}, 
                       ${document.getElementById("district").value}, 
                       ${document.getElementById("state").value}`;
      const url = https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)};
      const res = await fetch(url);
      const data = await res.json();
      if (data && data.length > 0) {
        const loc = data[0];
        const lat = parseFloat(loc.lat);
        const lon = parseFloat(loc.lon);
        marker.setLatLng([lat, lon]);
        map.setView([lat, lon], 15);
        document.getElementById("latitude").value = lat;
        document.getElementById("longitude").value = lon;
        document.getElementById("locationDisplay").value = loc.display_name;
      } else {
        alert("Address not found. Please check inputs.");
      }
    }

    document.getElementById("updateLocationBtn").addEventListener("click", geocodeAddress);

    // File previews
    function setupPreview(inputId, previewId) {
      document.getElementById(inputId).addEventListener('change', function(event) {
        const file = event.target.files[0];
        const preview = document.getElementById(previewId);
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            preview.src = e.target.result;
            preview.classList.remove('hidden');
          }
          reader.readAsDataURL(file);
        } else {
          preview.src = '';
          preview.classList.add('hidden');
        }
      });
    }

    setupPreview('licenseCertificate', 'licensePreview');
    setupPreview('hospitalPhoto', 'hospitalPreview');


    // Form submission
    document.getElementById('hospitalRegisterForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formMessage = document.getElementById('formMessage');
      const password = document.getElementById('password').value;
      const passwordError = document.getElementById('passwordError');

      if (password.length < 6) {
        passwordError.classList.remove('hidden');
        return;
      } else {
        passwordError.classList.add('hidden');
      }

      const formData = new FormData(e.target);
      const response = await fetch('/hospital/register', {
        method: 'POST',
        body: formData
      });
      const result = await response.json();

      formMessage.classList.remove('hidden');
      if (response.ok) {
        formMessage.classList.remove('bg-red-100', 'text-red-700');
        formMessage.classList.add('bg-green-100', 'text-green-700');
        formMessage.textContent = 'Hospital registered successfully!';
      setTimeout(() => { window.location.replace('/hospital/login'); }, 2000);

      } else {
        formMessage.classList.remove('bg-green-100', 'text-green-700');
        formMessage.classList.add('bg-red-100', 'text-red-700');
        formMessage.textContent = result.error || 'Registration failed';
      }
    });
  </script>
</body>
</html>